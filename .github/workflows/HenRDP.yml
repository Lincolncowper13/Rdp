name: Setup and Connect RDP with Tailscale

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Download and install Tailscale
      run: |
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup-latest.exe"
        Start-Process -FilePath "tailscale-setup-latest.exe" -ArgumentList "/silent" -Wait

    - name: Verify Tailscale installation
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" version

    - name: Add Tailscale AuthKey
      run: |
        $authKey = "${{ secrets.TAILSCALE_AUTHKEY }}"  # Menggunakan Tailscale AuthKey dari GitHub Secrets
        Write-Host "Using Tailscale AuthKey: $authKey"
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$authKey
        Start-Sleep -Seconds 5  # Tunggu beberapa detik agar koneksi berhasil

    - name: Set RDP Username and Password
      run: |
        $username = "Administrator"
        $password = "HenCoders2024"
        Write-Host "RDP username: $username, Password: $password"
      
    - name: Get Tailscale IP address
      run: |
        $tailscaleIP = & "C:\Program Files\Tailscale\tailscale.exe" status | Select-String -Pattern "Tailscale IP:" | ForEach-Object { $_.Line.Trim() }
        Write-Host "Tailscale IP Address: $tailscaleIP"

    - name: Start RDP session
      run: |
        Write-Host "Access RDP using the Tailscale IP and login with username '$username' and password '$password'"
